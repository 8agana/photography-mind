# MCP Code Review Fixes - 2025-12-10

Work document tracking fixes from code review.

---

## Critical Fixes

### 1. `create_family` parameter name mismatch
**Status**: [x] DONE
**Files**: `src/router.rs:165-182`, `src/server.rs:814-829`

**Problem**: Router schema defines `delivery_email` as required param, but server handler extracted `email`.

**Fix**: Changed server handler to extract `delivery_email` instead of `email`.

---

### 2. `mark_gallery_sent` / `mark_shoot_sent` don't verify edge exists
**Status**: [x] DONE
**Files**: `src/server.rs:215-287`, `src/server.rs:473-544`

**Problem**: UPDATE on non-existent edge silently succeeded, handler reported `success: true`.

**Fix**: Added edge existence check before UPDATE, returns appropriate error with context if missing.

---

## Medium Fixes

### 3. `create_shoot` parameter name mismatch
**Status**: [x] DONE
**Files**: `src/router.rs:152-155`, `src/server.rs:416-421`

**Problem**: Router schema defines `date`, server extracted `shoot_date`.

**Fix**: Changed server to extract `date` to match router schema.

---

### 4. `link_family_shoot` can create duplicate edges
**Status**: [x] DONE
**Files**: `src/server.rs:871-940`

**Problem**: `RELATE` without uniqueness check allowed duplicate edges.

**Fix**: Added existence check before RELATE, returns error with existing edge ID if already linked. Also added `created_at = time::now()` to RELATE.

---

## Minor Fixes

### 5. `handle_status` missing shoot tables
**Status**: [x] DONE
**Files**: `src/server.rs:32-64`

**Problem**: Status counts didn't include `shoot` and `family_shoot` tables.

**Fix**: Added `shoot` and `family_shoot` to tables array.

---

### 6. Duplicate `PendingFamily` struct
**Status**: [x] DONE
**Files**: `src/server.rs:316-321`, `src/server.rs:599-604`

**Problem**: Same struct defined twice in server.rs.

**Fix**: Moved to `src/photography/models.rs`, both usages now import from there.

---

### 7. Blocking file I/O in sync handlers
**Status**: [x] DONE
**Files**: `src/server.rs:1089`, `src/server.rs:1187`

**Problem**: `std::fs::read_to_string` was blocking in async context.

**Fix**: Changed to `tokio::fs::read_to_string` with `.await`.

---

## Summary

All 7 fixes completed and verified with `cargo check` - clean compilation.

**Files modified**:
- `src/server.rs` - All handler fixes
- `src/photography/models.rs` - Added `PendingFamily` struct

**Next steps**:
- Run `cargo build --release` for production binary
- Test affected MCP tools via client
